#!/bin/bash

# Kiểm tra quyền root
if [ "$EUID" -ne 0 ]; then
    echo "❌ Vui lòng chạy script bằng quyền root."
    exit 1
fi

# Cài đặt dante-server
apt update -y && apt install -y dante-server pwgen

# Tạo user/pass ngẫu nhiên
user="user$(shuf -i 1000-9999 -n 1)"
pass=$(pwgen 10 1)

# Thêm user vào hệ thống
useradd -M -s /usr/sbin/nologin "$user"
echo "$user:$pass" | chpasswd

# Tạo file cấu hình cho dante
cat > /etc/danted.conf <<EOF
logoutput: /var/log/danted.log

internal: 0.0.0.0 port = 6969
external: eth0

method: username

client pass {
    from: 0.0.0.0/0 to: 0.0.0.0/0
    log: connect disconnect error
}

pass {
    from: 0.0.0.0/0 to: 0.0.0.0/0
    protocol: tcp udp
    log: connect disconnect error
    method: username
}
EOF

# Tự động tìm interface nếu eth0 không tồn tại
iface=$(ip route | grep default | awk '{print $5}' | head -n1)
sed -i "s/external: eth0/external: $iface/" /etc/danted.conf

# Bật dịch vụ Dante
cat > /etc/systemd/system/danted.service <<EOF
[Unit]
Description=Dante SOCKS5 Proxy
After=network.target

[Service]
Type=simple
ExecStart=/usr/sbin/danted -f /etc/danted.conf
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# Khởi động dịch vụ
systemctl daemon-reexec
systemctl daemon-reload
systemctl enable danted
systemctl restart danted

# Lấy IP public
ip=$(curl -s ifconfig.me)

# Hiển thị thông tin proxy SOCKS5
echo ""
echo "✅ SOCKS5 Proxy đã được thiết lập thành công!"
echo "--------------------------------------------"
echo "🔌 Host    : $ip"
echo "📍 Port    : 6969"
echo "👤 User    : $user"
echo "🔑 Pass    : $pass"
echo "🌐 Proxy   : socks5://$user:$pass@$ip:6969"
echo "--------------------------------------------"
